name: Feature Checks

on:
  pull_request:
    branches:
      - develop
      - dev  # Support both naming conventions
    types: [opened, synchronize, reopened]

# Cancel in-progress runs when a new commit is pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write  # For posting PR comments

# Project-specific configuration - customize these for different projects
env:
  PROJECT_NAME: testpad
  PYTHON_VERSION: "3.12"
  WORKING_DIR: testpad
  # Test configuration
  TEST_PATTERN: "tests/"
  # Coverage configuration
  COVERAGE_SOURCE: src/testpad

jobs:
  validate:
    name: Validate Feature Branch
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "${{ env.WORKING_DIR }}/pyproject.toml"

      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          uv sync --all-extras

      - name: Run linting (ruff)
        id: lint
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "::group::Ruff Check"
          uv run ruff check . --output-format=github
          echo "::endgroup::"
        continue-on-error: true

      - name: Run code formatting check (ruff format)
        id: format
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "::group::Ruff Format Check"
          uv run ruff format --check .
          echo "::endgroup::"
        continue-on-error: true

      - name: Run unit tests with coverage
        id: test
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "::group::Running Tests with Coverage"
          uv run pytest ${{ env.TEST_PATTERN }} -v --tb=short \
            --junitxml=test-results.xml \
            --cov=${{ env.COVERAGE_SOURCE }} \
            --cov-report=term-missing \
            --cov-report=xml || EXIT_CODE=$?

          # Exit code 5 means no tests collected (acceptable)
          if [ "${EXIT_CODE:-0}" -eq 5 ]; then
            echo "‚ö†Ô∏è No tests found - this is acceptable"
            exit 0
          elif [ "${EXIT_CODE:-0}" -ne 0 ]; then
            echo "‚ùå Tests failed"
            exit $EXIT_CODE
          fi
          echo "::endgroup::"
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            ${{ env.WORKING_DIR }}/test-results.xml
            ${{ env.WORKING_DIR }}/coverage.xml
          retention-days: 7
          if-no-files-found: ignore

      - name: Generate PR comment
        if: always()
        id: pr-comment
        shell: bash
        run: |
          if [ "${{ steps.lint.outcome }}" == "success" ]; then
            lint_status="‚úÖ Passed"
          else
            lint_status="‚ùå Failed"
          fi

          if [ "${{ steps.format.outcome }}" == "success" ]; then
            format_status="‚úÖ Passed"
          else
            format_status="‚ùå Failed"
          fi

          if [ "${{ steps.test.outcome }}" == "success" ]; then
            test_status="‚úÖ Passed"
          else
            test_status="‚ùå Failed"
          fi

          if [ "${{ steps.coverage.outcome }}" == "success" ]; then
            coverage_status="‚úÖ Passed"
          else
            coverage_status="‚ö†Ô∏è Warning"
          fi

          cat > pr-comment.txt << 'EOF'
          ## Feature Checks Results

          | Check | Status |
          |-------|--------|
          | üîç Linting (ruff check) | ${lint_status} |
          | üé® Formatting (ruff format) | ${format_status} |
          | üß™ Unit Tests | ${test_status} |
          | üìä Code Coverage | ${coverage_status} |

          ### Details
          - **Branch**: `${{ github.head_ref }}`
          - **Commit**: `${{ github.event.pull_request.head.sha }}`
          - **Run**: [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ---
          *Automated checks by feature-checks.yml*
          EOF

          # Substitute variables
          sed -i "s/\${lint_status}/$lint_status/g" pr-comment.txt
          sed -i "s/\${format_status}/$format_status/g" pr-comment.txt
          sed -i "s/\${test_status}/$test_status/g" pr-comment.txt
          sed -i "s/\${coverage_status}/$coverage_status/g" pr-comment.txt

          # Output for debugging
          cat pr-comment.txt

      - name: Post PR comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('pr-comment.txt', 'utf8');

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Feature Checks Results')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Check overall status
        if: always()
        shell: bash
        run: |
          failed=false
          if [ "${{ steps.lint.outcome }}" != "success" ]; then failed=true; fi
          if [ "${{ steps.format.outcome }}" != "success" ]; then failed=true; fi
          if [ "${{ steps.test.outcome }}" != "success" ]; then failed=true; fi

          if [ "$failed" = true ]; then
            echo "‚ùå One or more checks failed"
            exit 1
          else
            echo "‚úÖ All checks passed"
          fi
