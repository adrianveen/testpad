name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v1.11.0
  workflow_dispatch:  # Allow manual trigger

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for changelog generation

      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: "3.12"
          miniconda-version: "latest"
          activate-environment: testpad-release
          environment-file: environment-release.yml

      - name: Verify conda environment
        shell: powershell
        run: |
          conda info
          conda list

      - name: Get version from tag or file
        id: version
        shell: powershell
        run: |
          if ($env:GITHUB_REF -match 'refs/tags/v(.*)') {
            $version = $matches[1]
            echo "VERSION=$version" >> $env:GITHUB_OUTPUT
            echo "TAG_NAME=v$version" >> $env:GITHUB_OUTPUT
          } else {
            # Fallback to version.py if no tag
            $content = Get-Content "src/testpad/version.py"
            $version = ($content | Select-String '__version__ = "([^"]+)"').Matches.Groups[1].Value
            echo "VERSION=$version" >> $env:GITHUB_OUTPUT
            echo "TAG_NAME=v$version" >> $env:GITHUB_OUTPUT
          }
          echo "Building version: $version"

      - name: Clean previous build artifacts
        shell: powershell
        run: |
          if (Test-Path "dist") { Remove-Item -Recurse -Force "dist" }
          if (Test-Path "build") { Remove-Item -Recurse -Force "build" }

      - name: Build release executable
        shell: powershell
        run: |
          $Spec = "build_config/testpad_main-release.spec"
          if (-not (Test-Path $Spec)) {
            throw "Spec file not found: $Spec"
          }

          Write-Host "Building release version..." -ForegroundColor Cyan
          conda run -n testpad-release python -m PyInstaller $Spec --noconfirm

          Write-Host "Build complete!" -ForegroundColor Green

      - name: Build portable executable
        shell: powershell
        run: |
          $Spec = "build_config/testpad_main-portable.spec"
          if (-not (Test-Path $Spec)) {
            throw "Spec file not found: $Spec"
          }

          Write-Host "Building portable version..." -ForegroundColor Cyan
          conda run -n testpad-release python -m PyInstaller $Spec --noconfirm

          Write-Host "Portable build complete!" -ForegroundColor Green

      - name: List build output
        shell: powershell
        run: |
          Write-Host "=== Build artifacts ===" -ForegroundColor Yellow
          Get-ChildItem -Path "dist" -Recurse | Select-Object FullName

      - name: Package release artifacts
        shell: powershell
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"

          # Create output directory for zips
          New-Item -ItemType Directory -Force -Path "artifacts" | Out-Null

          # Find the release build directory
          $releaseDir = Get-ChildItem -Path "dist" -Directory -Recurse | Where-Object { $_.Name -match "testpad.*release" } | Select-Object -First 1
          if (-not $releaseDir) {
            throw "Unable to locate release build directory under dist/"
          }

          $releaseZip = "artifacts/testpad-v$version-windows-release.zip"
          Write-Host "Packaging release build: $($releaseDir.FullName) -> $releaseZip" -ForegroundColor Cyan
          if (Test-Path $releaseZip) { Remove-Item $releaseZip -Force }
          Compress-Archive -Path (Join-Path $releaseDir.FullName '*') -DestinationPath $releaseZip -Force

          # Find the portable executable
          $portableExe = Get-ChildItem -Path "dist" -Recurse -Filter "*.exe" | Where-Object { $_.Name -match "portable" } | Select-Object -First 1
          if (-not $portableExe) {
            throw "Unable to locate portable executable under dist/"
          }

          $portableZip = "artifacts/testpad-v$version-windows-portable.zip"
          Write-Host "Packaging portable build: $($portableExe.FullName) -> $portableZip" -ForegroundColor Cyan
          if (Test-Path $portableZip) { Remove-Item $portableZip -Force }
          Compress-Archive -Path $portableExe.FullName -DestinationPath $portableZip -Force

          Write-Host "=== Packaged artifacts ===" -ForegroundColor Green
          Get-ChildItem -Path "artifacts"

      - name: Generate changelog
        id: changelog
        shell: powershell
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $tagName = "${{ steps.version.outputs.TAG_NAME }}"

          Write-Host "Generating changelog for version $version" -ForegroundColor Cyan

          # Determine whether the tag exists (manual dispatch may not have created it yet)
          $tagExists = (git tag --list $tagName | Measure-Object).Count -gt 0
          $tagRef = if ($tagExists) { $tagName } else { "HEAD" }
          $headCommit = $null
          if (-not $tagExists) {
            Write-Warning "Tag $tagName not found. Using HEAD for changelog generation."
            $headCommit = (git rev-parse HEAD).Trim()
          }

          # Get the previous tag if available
          $tags = @(git tag --sort=-version:refname)
          $previousTag = $null
          if ($tagExists -and $tags.Count -gt 0) {
            $currentTagIndex = [System.Array]::IndexOf($tags, $tagName)
            if ($currentTagIndex -ge 0 -and $currentTagIndex -lt ($tags.Count - 1)) {
              $previousTag = $tags[$currentTagIndex + 1]
            }
          }

          # Generate changelog
          $changelogLines = @(
            "## What's Changed",
            ""
          )

          if ($previousTag) {
            Write-Host "Comparing $previousTag...$tagName" -ForegroundColor Yellow
            $commits = git log "$previousTag..$tagRef" --pretty=format:"- %s (%h)" --no-merges
          } else {
            Write-Host "Gathering commits up to $tagRef" -ForegroundColor Yellow
            $commits = git log $tagRef --pretty=format:"- %s (%h)" --no-merges
          }

          if ($commits) {
            $changelogLines += $commits
          } else {
            $changelogLines += "- Initial release"
          }

          $fullChangelogUrl = if ($previousTag) {
            "https://github.com/${{ github.repository }}/compare/$previousTag...$tagRef"
          } elseif ($tagExists) {
            "https://github.com/${{ github.repository }}/releases/tag/$tagRef"
          } else {
            "https://github.com/${{ github.repository }}/commit/$headCommit"
          }

          $changelogLines += @(
            "",
            "",
            "## Installation",
            "",
            "Download the appropriate build for your needs:",
            "",
            "- **Release Build (Recommended)**: `testpad-v$version-windows-release.zip` - One-directory build with all dependencies",
            "- **Portable Build**: `testpad-v$version-windows-portable.zip` - Single executable file (slower startup)",
            "",
            "Extract and run `testpad_main.exe` (release) or the portable executable.",
            "",
            "## Requirements",
            "",
            "- Windows 10 or later",
            "- No additional dependencies required (all bundled)",
            "",
            "---",
            "",
            "**Full Changelog**: $fullChangelogUrl"
          )

          $changelog = $changelogLines -join "`n"
          $changelog += "`n"

          # Save to file for the release
          $changelog | Out-File -FilePath "CHANGELOG.md" -Encoding utf8

          Write-Host "Changelog generated successfully" -ForegroundColor Green
          Write-Host $changelog

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: testpad-windows-builds
          path: artifacts/*.zip
          retention-days: 90

      - name: Create draft release
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          prerelease: false
          name: Testpad ${{ steps.version.outputs.TAG_NAME }}
          tag_name: ${{ steps.version.outputs.TAG_NAME }}
          body_path: CHANGELOG.md
          files: |
            artifacts/*.zip
          token: ${{ secrets.GITHUB_TOKEN }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        shell: powershell
        run: |
          Write-Host ""
          Write-Host "================================================" -ForegroundColor Green
          Write-Host "  Build Complete!" -ForegroundColor Green
          Write-Host "================================================" -ForegroundColor Green
          Write-Host ""
          Write-Host "Version: ${{ steps.version.outputs.VERSION }}" -ForegroundColor Cyan
          Write-Host "Tag: ${{ steps.version.outputs.TAG_NAME }}" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "A draft release has been created at:" -ForegroundColor Yellow
          Write-Host "https://github.com/${{ github.repository }}/releases" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "Next steps:" -ForegroundColor Cyan
          Write-Host "1. Review the draft release" -ForegroundColor White
          Write-Host "2. Edit the changelog if needed" -ForegroundColor White
          Write-Host "3. Publish the release when ready" -ForegroundColor White
          Write-Host ""
